{{- define "main" }}

{{- if (and site.Params.profileMode.enabled .IsHome) }}
    {{- partial "index_profile.html" . }}
{{- else }}

    {{- if not .IsHome | and .Title }}
        <header class="page-header">
            {{- partial "breadcrumbs.html" . }}
            <h1>
                {{ .Title }}
                {{- if and (or (eq .Kind `term`) (eq .Kind `section`)) (.Param "ShowRssButtonInSectionTermList") }}
                    {{- with .OutputFormats.Get "rss" }}
                        <a href="{{ .RelPermalink }}" title="RSS" aria-label="RSS">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" height="23">
                                <path d="M4 11a9 9 0 0 1 9 9" />
                                <path d="M4 4a16 16 0 0 1 16 16" />
                                <circle cx="5" cy="19" r="1" />
                            </svg>
                        </a>
                    {{- end }}
                {{- end }}
            </h1>
            {{- if .Description }}
                <div class="post-description">
                    {{ .Description | markdownify }}
                </div>
            {{- end }}
        </header>
    {{- end }}

    {{- if .Content }}
        <div class="post-content">
            {{- if not (.Param "disableAnchoredHeadings") }}
                {{- partial "anchored_headings.html" .Content -}}
            {{- else }}{{ .Content }}{{ end }}
        </div>
    {{- end }}

    {{- $pages := union .RegularPages .Sections }}
    {{- if .IsHome }}
        {{- $pages = where site.RegularPages "Type" "in" site.Params.mainSections }}
        {{- $pages = where $pages "Params.hiddenInHomeList" "!=" "true"  }}
    {{- end }}

    {{- $paginator := .Paginate $pages }}

    {{- if and .IsHome site.Params.homeInfoParams (eq $paginator.PageNumber 1) }}
        {{- partial "home_info.html" . }}
    {{- end }}

    {{- $term := .Data.Term }}

    <!-- Filter Buttons - Only on Posts page -->
    {{- if eq .Section "posts" }}
    <div class="tag-filter-container">
        <button class="filter-btn active" data-filter="all">All</button>
        {{- $allTags := slice }}
        {{- range $paginator.Pages }}
            {{- if .Params.tags }}
                {{- range .Params.tags }}
                    {{- $allTags = $allTags | append . }}
                {{- end }}
            {{- end }}
        {{- end }}
        {{- range ($allTags | uniq) }}
            <button class="filter-btn" data-filter="{{ . }}">{{ . }}</button>
        {{- end }}
    </div>
    {{- end }}

    <div class="posts-grid" id="posts-container">
        {{- range $index, $page := $paginator.Pages }}
            {{- $class := "post-entry" }}
            {{- $user_preferred := or site.Params.disableSpecial1stPost site.Params.homeInfoParams }}
            {{- if (and $.IsHome (eq $paginator.PageNumber 1) (eq $index 0) (not $user_preferred)) }}
                {{- $class = "first-entry" }}
            {{- else if $term }}
                {{- $class = "post-entry tag-entry" }}
            {{- end }}

            {{- if eq $page.Title "Note Base" }}
                <a href="https://note-base.emcybertrack.com/" class="{{ $class }}" style="display:block; color:inherit; text-decoration:none;" aria-label="Go to Note Base">
                    <article data-tags="{{ range $i, $tag := $page.Params.tags }}{{ if $i }},{{ end }}{{ $tag }}{{ end }}">
                        {{- $isHidden := ($page.Param "cover.hiddenInList") | default ($page.Param "cover.hidden") | default false }}
                        {{- partial "cover.html" (dict "cxt" $page "IsSingle" false "isHidden" $isHidden) }}
                        <header class="entry-header">
                            <h2 class="entry-hint-parent">
                                {{- $page.Title }}
                                {{- if $page.Draft }}
                                <span class="entry-hint" title="Draft">
                                    <!-- ... -->
                                </span>
                                {{- end }}
                            </h2>
                        </header>
                        {{- if (ne ($page.Param "hideSummary") true) }}
                            <div class="entry-content">
                                <p>{{ $page.Summary | plainify | htmlUnescape }}{{ if $page.Truncated }}...{{ end }}</p>
                            </div>
                        {{- end }}
                        {{- if not ($page.Param "hideMeta") }}
                            <footer class="entry-footer">
                                {{- partial "post_meta.html" $page -}}
                            </footer>
                        {{- end }}
                    </article>
                </a>
            {{- else }}
                <article class="{{ $class }}" data-tags="{{ range $i, $tag := .Params.tags }}{{ if $i }},{{ end }}{{ $tag }}{{ end }}">
                    {{- $isHidden := (.Param "cover.hiddenInList") | default (.Param "cover.hidden") | default false }}
                    {{- partial "cover.html" (dict "cxt" . "IsSingle" false "isHidden" $isHidden) }}
                    <header class="entry-header">
                        <h2 class="entry-hint-parent">
                            {{- .Title }}
                            {{- if .Draft }}
                            <span class="entry-hint" title="Draft">
                                <!-- ... -->
                            </span>
                            {{- end }}
                        </h2>
                    </header>
                    {{- if (ne (.Param "hideSummary") true) }}
                        <div class="entry-content">
                            <p>{{ .Summary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}</p>
                        </div>
                    {{- end }}
                    {{- if not (.Param "hideMeta") }}
                        <footer class="entry-footer">
                            {{- partial "post_meta.html" . -}}
                        </footer>
                    {{- end }}
                    <a class="entry-link" aria-label="post link to {{ .Title | plainify }}" href="{{ .Permalink }}"></a>
                </article>
            {{- end }}
        {{- end }}
    </div>

    {{- if gt $paginator.TotalPages 1 }}
        <footer class="page-footer">
            <nav class="pagination">
                {{- if $paginator.HasPrev }}
                    <a class="prev" href="{{ $paginator.Prev.URL | absURL }}">
                        «&nbsp;{{ i18n "prev_page" }}&nbsp;
                        {{- if (.Param "ShowPageNums") }}
                            {{- sub $paginator.PageNumber 1 }}/{{ $paginator.TotalPages }}
                        {{- end }}
                    </a>
                {{- end }}
                {{- if $paginator.HasNext }}
                    <a class="next" href="{{ $paginator.Next.URL | absURL }}">
                        {{- i18n "next_page" }}&nbsp;
                        {{- if (.Param "ShowPageNums") }}
                            {{- add 1 $paginator.PageNumber }}/{{ $paginator.TotalPages }}
                        {{- end }}&nbsp;»
                    </a>
                {{- end }}
            </nav>
        </footer>
    {{- end }}

{{- end }}{{/* end profileMode */}}
{{- end }}{{- /* end main */ -}}
